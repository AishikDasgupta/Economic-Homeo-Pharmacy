<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Products - Economic Homeo Pharmacy</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../style.css">
    <style>
        /* Additional styles for product page integration */
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .product-image {
            height: 200px;
            object-fit: contain;
        }
        .pagination .page-item.active .page-link {
            background-color: #006400;
            border-color: #006400;
        }
        .pagination .page-link {
            color: #006400;
        }
        .category-filter {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .category-filter:hover, .category-filter.active {
            background-color: #006400;
            color: white;
        }
        #loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Header and Navigation (Same as existing website) -->
    <header>
        <!-- Your existing navigation code here -->
    </header>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Products Hero Section -->
    <section class="hero-section py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-12 text-center">
                    <h1 class="display-4">Our Products</h1>
                    <p class="lead">Discover our range of high-quality homeopathic remedies</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Products Section with CMS Integration -->
    <section class="products-section py-5">
        <div class="container">
            <!-- Search and Filter Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" id="search-input" class="form-control" placeholder="Search products...">
                        <button class="btn btn-success" id="search-button" type="button">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-success dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort By
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                            <li><a class="dropdown-item sort-option" data-sort="name-asc" href="#">Name (A-Z)</a></li>
                            <li><a class="dropdown-item sort-option" data-sort="name-desc" href="#">Name (Z-A)</a></li>
                            <li><a class="dropdown-item sort-option" data-sort="price-asc" href="#">Price (Low to High)</a></li>
                            <li><a class="dropdown-item sort-option" data-sort="price-desc" href="#">Price (High to Low)</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Categories and Products Row -->
            <div class="row">
                <!-- Categories Sidebar -->
                <div class="col-md-3 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Categories</h5>
                        </div>
                        <div class="list-group list-group-flush" id="categories-list">
                            <a href="#" class="list-group-item list-group-item-action category-filter active" data-category="all">All Products</a>
                            <!-- Categories will be loaded dynamically from the CMS -->
                            <div class="text-center p-3" id="categories-loading">
                                <div class="spinner-border spinner-border-sm text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Grid -->
                <div class="col-md-9">
                    <div class="row" id="products-container">
                        <!-- Products will be loaded dynamically from the CMS -->
                        <div class="text-center p-5" id="products-loading">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading products...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <nav aria-label="Product pagination">
                                <ul class="pagination justify-content-center" id="pagination-container">
                                    <!-- Pagination will be generated dynamically -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer (Same as existing website) -->
    <footer>
        <!-- Your existing footer code here -->
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (if needed) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Import the CMS API Integration -->
    <script type="module">
        import { getCategories, getProducts, getProductsByCategory, addToCart } from './api-integration.js';

        // Global variables for state management
        let currentPage = 1;
        let currentCategory = 'all';
        let currentSearch = '';
        let currentSort = 'name-asc';
        let totalPages = 1;
        const perPage = 12;

        // DOM Elements
        const productsContainer = document.getElementById('products-container');
        const categoriesList = document.getElementById('categories-list');
        const paginationContainer = document.getElementById('pagination-container');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const productsLoading = document.getElementById('products-loading');
        const categoriesLoading = document.getElementById('categories-loading');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            // Load categories
            await loadCategories();
            
            // Load initial products
            await loadProducts();
            
            // Set up event listeners
            setupEventListeners();
        });

        // Load categories from the CMS
        async function loadCategories() {
            try {
                const categories = await getCategories();
                
                // Hide loading spinner
                categoriesLoading.style.display = 'none';
                
                // Populate categories list
                categories.forEach(category => {
                    const categoryElement = document.createElement('a');
                    categoryElement.href = '#';
                    categoryElement.className = 'list-group-item list-group-item-action category-filter';
                    categoryElement.setAttribute('data-category', category.id);
                    categoryElement.textContent = category.name;
                    
                    categoriesList.appendChild(categoryElement);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                categoriesLoading.innerHTML = '<p class="text-danger">Failed to load categories</p>';
            }
        }

        // Load products from the CMS
        async function loadProducts() {
            try {
                // Show loading state
                productsLoading.style.display = 'block';
                productsContainer.innerHTML = '';
                
                // Prepare filters
                const filters = {
                    page: currentPage,
                    per_page: perPage,
                    search: currentSearch
                };
                
                // Add sort parameters
                if (currentSort === 'name-asc') {
                    filters.sort_by = 'name';
                    filters.sort_direction = 'asc';
                } else if (currentSort === 'name-desc') {
                    filters.sort_by = 'name';
                    filters.sort_direction = 'desc';
                } else if (currentSort === 'price-asc') {
                    filters.sort_by = 'price';
                    filters.sort_direction = 'asc';
                } else if (currentSort === 'price-desc') {
                    filters.sort_by = 'price';
                    filters.sort_direction = 'desc';
                }
                
                // Fetch products
                let response;
                if (currentCategory === 'all') {
                    response = await getProducts(filters);
                } else {
                    response = await getProductsByCategory(currentCategory, currentPage, perPage);
                }
                
                // Update pagination info
                totalPages = Math.ceil(response.total / perPage);
                
                // Hide loading state
                productsLoading.style.display = 'none';
                
                // Display products
                if (response.data.length === 0) {
                    productsContainer.innerHTML = '<div class="col-12 text-center"><p>No products found</p></div>';
                } else {
                    response.data.forEach(product => {
                        productsContainer.appendChild(createProductCard(product));
                    });
                }
                
                // Update pagination
                updatePagination();
                
            } catch (error) {
                console.error('Error loading products:', error);
                productsLoading.style.display = 'none';
                productsContainer.innerHTML = '<div class="col-12 text-center"><p class="text-danger">Failed to load products</p></div>';
            }
        }

        // Create a product card element
        function createProductCard(product) {
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-4 col-sm-6 mb-4';
            
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card product-card h-100';
            
            // Product image
            const img = document.createElement('img');
            img.src = product.primary_image ? product.primary_image.image_path : 'placeholder.jpg';
            img.className = 'card-img-top product-image p-3';
            img.alt = product.name;
            
            // Card body
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body d-flex flex-column';
            
            // Product title
            const title = document.createElement('h5');
            title.className = 'card-title';
            title.textContent = product.name;
            
            // Product price
            const price = document.createElement('p');
            price.className = 'card-text text-success fw-bold';
            price.textContent = `â‚¹${product.current_price}`;
            
            // Product description (truncated)
            const description = document.createElement('p');
            description.className = 'card-text small text-muted mb-3';
            description.textContent = product.description.length > 100 ? 
                product.description.substring(0, 100) + '...' : 
                product.description;
            
            // View details link
            const detailsLink = document.createElement('a');
            detailsLink.href = `product-details.html?id=${product.id}`;
            detailsLink.className = 'btn btn-outline-success btn-sm me-2';
            detailsLink.textContent = 'View Details';
            
            // Add to cart button
            const cartButton = document.createElement('button');
            cartButton.className = 'btn btn-success btn-sm';
            cartButton.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
            cartButton.onclick = (e) => {
                e.preventDefault();
                addToCart(product);
                showAddedToCartMessage(product.name);
            };
            
            // Button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-auto d-flex';
            buttonContainer.appendChild(detailsLink);
            buttonContainer.appendChild(cartButton);
            
            // Assemble card
            cardBody.appendChild(title);
            cardBody.appendChild(price);
            cardBody.appendChild(description);
            cardBody.appendChild(buttonContainer);
            
            cardDiv.appendChild(img);
            cardDiv.appendChild(cardBody);
            
            colDiv.appendChild(cardDiv);
            
            return colDiv;
        }

        // Update pagination controls
        function updatePagination() {
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.setAttribute('aria-label', 'Previous');
            prevLink.innerHTML = '<span aria-hidden="true">&laquo;</span>';
            prevLink.onclick = (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    loadProducts();
                }
            };
            
            prevLi.appendChild(prevLink);
            paginationContainer.appendChild(prevLi);
            
            // Page numbers
            const maxPages = 5; // Maximum number of page links to show
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.onclick = (e) => {
                    e.preventDefault();
                    currentPage = i;
                    loadProducts();
                };
                
                pageLi.appendChild(pageLink);
                paginationContainer.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.setAttribute('aria-label', 'Next');
            nextLink.innerHTML = '<span aria-hidden="true">&raquo;</span>';
            nextLink.onclick = (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    loadProducts();
                }
            };
            
            nextLi.appendChild(nextLink);
            paginationContainer.appendChild(nextLi);
        }

        // Set up event listeners
        function setupEventListeners() {
            // Category filter clicks
            categoriesList.addEventListener('click', (e) => {
                if (e.target.classList.contains('category-filter')) {
                    e.preventDefault();
                    
                    // Update active class
                    document.querySelectorAll('.category-filter').forEach(el => {
                        el.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Update current category and reset page
                    currentCategory = e.target.getAttribute('data-category');
                    currentPage = 1;
                    
                    // Load products for this category
                    loadProducts();
                }
            });
            
            // Search button click
            searchButton.addEventListener('click', () => {
                currentSearch = searchInput.value.trim();
                currentPage = 1;
                loadProducts();
            });
            
            // Search input enter key
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentSearch = searchInput.value.trim();
                    currentPage = 1;
                    loadProducts();
                }
            });
            
            // Sort options
            document.querySelectorAll('.sort-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentSort = e.target.getAttribute('data-sort');
                    document.getElementById('sortDropdown').textContent = e.target.textContent;
                    loadProducts();
                });
            });
        }

        // Show added to cart message
        function showAddedToCartMessage(productName) {
            // Create toast element
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
            toastContainer.style.zIndex = '5';
            
            const toastElement = document.createElement('div');
            toastElement.className = 'toast';
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            
            const toastHeader = document.createElement('div');
            toastHeader.className = 'toast-header bg-success text-white';
            toastHeader.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Added to Cart</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            `;
            
            const toastBody = document.createElement('div');
            toastBody.className = 'toast-body';
            toastBody.textContent = `${productName} has been added to your cart.`;
            
            toastElement.appendChild(toastHeader);
            toastElement.appendChild(toastBody);
            toastContainer.appendChild(toastElement);
            
            // Add to document
            document.body.appendChild(toastContainer);
            
            // Initialize and show toast
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // Remove from DOM after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastContainer);
            });
        }
    </script>
</body>
</html>