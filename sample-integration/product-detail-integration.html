<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Economic Homeo Pharmacy</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../style.css">
    <style>
        /* Additional styles for product detail page */
        .product-image-gallery img {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .product-image-gallery img.active {
            border-color: #006400;
        }
        .product-main-image {
            height: 400px;
            object-fit: contain;
        }
        .product-thumbnail {
            height: 80px;
            object-fit: cover;
        }
        .quantity-selector {
            max-width: 120px;
        }
        .nav-tabs .nav-link.active {
            color: #006400;
            border-bottom: 3px solid #006400;
            font-weight: bold;
        }
        .nav-tabs .nav-link {
            color: #333;
        }
        .related-product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .related-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        #loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Header and Navigation (Same as existing website) -->
    <header>
        <!-- Your existing navigation code here -->
    </header>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Product Detail Section with CMS Integration -->
    <section class="product-detail-section py-5">
        <div class="container">
            <div id="product-loading" class="text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading product details...</p>
            </div>

            <div id="product-container" class="d-none">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="../index.html">Home</a></li>
                        <li class="breadcrumb-item"><a href="../Our products.html">Products</a></li>
                        <li class="breadcrumb-item active" id="product-breadcrumb-name" aria-current="page">Product Name</li>
                    </ol>
                </nav>

                <!-- Product Details Row -->
                <div class="row">
                    <!-- Product Images -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <img id="product-main-image" src="placeholder.jpg" alt="Product Image" class="img-fluid product-main-image">
                                </div>
                                <div class="product-image-gallery d-flex justify-content-center flex-wrap" id="product-thumbnails">
                                    <!-- Thumbnails will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div class="col-md-6">
                        <h1 id="product-name" class="mb-3">Product Name</h1>
                        <div class="mb-3">
                            <span id="product-category" class="badge bg-success">Category</span>
                            <span id="product-stock-status" class="badge bg-success ms-2">In Stock</span>
                        </div>
                        <div class="mb-3">
                            <h3 id="product-price" class="text-success">â‚¹0.00</h3>
                        </div>
                        <div class="mb-4">
                            <p id="product-short-description">Product short description will appear here.</p>
                        </div>
                        <div class="mb-4">
                            <div class="d-flex align-items-center">
                                <label for="quantity" class="me-3">Quantity:</label>
                                <div class="input-group quantity-selector">
                                    <button class="btn btn-outline-secondary" type="button" id="decrease-quantity">-</button>
                                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1">
                                    <button class="btn btn-outline-secondary" type="button" id="increase-quantity">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <button id="add-to-cart-btn" class="btn btn-success btn-lg">
                                <i class="fas fa-shopping-cart me-2"></i> Add to Cart
                            </button>
                        </div>
                        <div class="mb-3">
                            <p><strong>SKU:</strong> <span id="product-sku">SKU123</span></p>
                        </div>
                    </div>
                </div>

                <!-- Product Tabs -->
                <div class="row mt-5">
                    <div class="col-12">
                        <ul class="nav nav-tabs mb-4" id="productTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">Description</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="benefits-tab" data-bs-toggle="tab" data-bs-target="#benefits" type="button" role="tab" aria-controls="benefits" aria-selected="false">Benefits</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage" type="button" role="tab" aria-controls="usage" aria-selected="false">Usage</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ingredients-tab" data-bs-toggle="tab" data-bs-target="#ingredients" type="button" role="tab" aria-controls="ingredients" aria-selected="false">Ingredients</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="productTabsContent">
                            <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                                <div id="product-description">Product description will appear here.</div>
                            </div>
                            <div class="tab-pane fade" id="benefits" role="tabpanel" aria-labelledby="benefits-tab">
                                <div id="product-benefits">Product benefits will appear here.</div>
                            </div>
                            <div class="tab-pane fade" id="usage" role="tabpanel" aria-labelledby="usage-tab">
                                <div id="product-usage">Product usage information will appear here.</div>
                            </div>
                            <div class="tab-pane fade" id="ingredients" role="tabpanel" aria-labelledby="ingredients-tab">
                                <div id="product-ingredients">Product ingredients will appear here.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Related Products -->
                <div class="row mt-5">
                    <div class="col-12">
                        <h3 class="mb-4">Related Products</h3>
                        <div class="row" id="related-products-container">
                            <!-- Related products will be loaded dynamically -->
                            <div class="text-center p-3" id="related-products-loading">
                                <div class="spinner-border spinner-border-sm text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading related products...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer (Same as existing website) -->
    <footer>
        <!-- Your existing footer code here -->
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (if needed) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Import the CMS API Integration -->
    <script type="module">
        import { getProduct, getProductsByCategory, addToCart } from './api-integration.js';

        // DOM Elements
        const productContainer = document.getElementById('product-container');
        const productLoading = document.getElementById('product-loading');
        const relatedProductsContainer = document.getElementById('related-products-container');
        const relatedProductsLoading = document.getElementById('related-products-loading');
        const loadingSpinner = document.getElementById('loading-spinner');
        const quantityInput = document.getElementById('quantity');
        const decreaseQuantityBtn = document.getElementById('decrease-quantity');
        const increaseQuantityBtn = document.getElementById('increase-quantity');
        const addToCartBtn = document.getElementById('add-to-cart-btn');

        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            if (!productId) {
                showError('Product ID is missing');
                return;
            }
            
            // Load product details
            await loadProductDetails(productId);
            
            // Set up event listeners
            setupEventListeners();
        });

        // Load product details from the CMS
        async function loadProductDetails(productId) {
            try {
                // Show loading state
                productLoading.style.display = 'block';
                productContainer.classList.add('d-none');
                
                // Fetch product details
                const product = await getProduct(productId);
                
                // Update product details in the UI
                updateProductUI(product);
                
                // Load related products
                if (product.category_id) {
                    loadRelatedProducts(product.category_id, product.id);
                }
                
                // Hide loading state
                productLoading.style.display = 'none';
                productContainer.classList.remove('d-none');
                
            } catch (error) {
                console.error('Error loading product details:', error);
                showError('Failed to load product details');
            }
        }

        // Update product UI with data from the CMS
        function updateProductUI(product) {
            // Update page title
            document.title = `${product.name} - Economic Homeo Pharmacy`;
            
            // Update breadcrumb
            document.getElementById('product-breadcrumb-name').textContent = product.name;
            
            // Update product details
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-category').textContent = product.category ? product.category.name : 'Uncategorized';
            document.getElementById('product-stock-status').textContent = product.in_stock ? 'In Stock' : 'Out of Stock';
            document.getElementById('product-stock-status').className = product.in_stock ? 'badge bg-success ms-2' : 'badge bg-danger ms-2';
            document.getElementById('product-price').textContent = `â‚¹${product.current_price}`;
            document.getElementById('product-short-description').textContent = product.short_description || product.description.substring(0, 150) + '...';
            document.getElementById('product-sku').textContent = product.sku || 'N/A';
            
            // Update product description tabs
            document.getElementById('product-description').innerHTML = product.description;
            document.getElementById('product-benefits').innerHTML = product.benefits || '<p>No benefits information available.</p>';
            document.getElementById('product-usage').innerHTML = product.usage || '<p>No usage information available.</p>';
            document.getElementById('product-ingredients').innerHTML = product.ingredients || '<p>No ingredients information available.</p>';
            
            // Update main product image
            const mainImage = document.getElementById('product-main-image');
            if (product.primary_image) {
                mainImage.src = product.primary_image.image_path;
                mainImage.alt = product.name;
            } else if (product.images && product.images.length > 0) {
                mainImage.src = product.images[0].image_path;
                mainImage.alt = product.name;
            } else {
                mainImage.src = 'placeholder.jpg';
                mainImage.alt = product.name;
            }
            
            // Update product thumbnails
            const thumbnailsContainer = document.getElementById('product-thumbnails');
            thumbnailsContainer.innerHTML = '';
            
            if (product.images && product.images.length > 0) {
                product.images.forEach((image, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = image.image_path;
                    thumbnail.alt = `${product.name} - Image ${index + 1}`;
                    thumbnail.className = `img-thumbnail product-thumbnail m-1 ${index === 0 ? 'active' : ''}`;
                    thumbnail.dataset.index = index;
                    thumbnail.onclick = () => {
                        // Update main image
                        mainImage.src = image.image_path;
                        
                        // Update active thumbnail
                        document.querySelectorAll('.product-thumbnail').forEach(thumb => {
                            thumb.classList.remove('active');
                        });
                        thumbnail.classList.add('active');
                    };
                    
                    thumbnailsContainer.appendChild(thumbnail);
                });
            }
            
            // Disable add to cart button if out of stock
            if (!product.in_stock) {
                addToCartBtn.disabled = true;
                addToCartBtn.innerHTML = '<i class="fas fa-ban me-2"></i> Out of Stock';
            } else {
                addToCartBtn.disabled = false;
                addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i> Add to Cart';
            }
        }

        // Load related products
        async function loadRelatedProducts(categoryId, currentProductId) {
            try {
                relatedProductsLoading.style.display = 'block';
                relatedProductsContainer.innerHTML = '';
                
                // Fetch products from the same category
                const response = await getProductsByCategory(categoryId, 1, 4);
                
                // Hide loading state
                relatedProductsLoading.style.display = 'none';
                
                // Filter out the current product
                const relatedProducts = response.data.filter(product => product.id !== currentProductId);
                
                if (relatedProducts.length === 0) {
                    relatedProductsContainer.innerHTML = '<div class="col-12 text-center"><p>No related products found</p></div>';
                    return;
                }
                
                // Display related products
                relatedProducts.slice(0, 4).forEach(product => {
                    relatedProductsContainer.appendChild(createRelatedProductCard(product));
                });
                
            } catch (error) {
                console.error('Error loading related products:', error);
                relatedProductsLoading.style.display = 'none';
                relatedProductsContainer.innerHTML = '<div class="col-12 text-center"><p class="text-danger">Failed to load related products</p></div>';
            }
        }

        // Create a related product card
        function createRelatedProductCard(product) {
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-3 col-sm-6 mb-4';
            
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card related-product-card h-100';
            
            // Product image
            const img = document.createElement('img');
            img.src = product.primary_image ? product.primary_image.image_path : 'placeholder.jpg';
            img.className = 'card-img-top p-2';
            img.style.height = '180px';
            img.style.objectFit = 'contain';
            img.alt = product.name;
            
            // Card body
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body d-flex flex-column';
            
            // Product title
            const title = document.createElement('h6');
            title.className = 'card-title';
            title.textContent = product.name;
            
            // Product price
            const price = document.createElement('p');
            price.className = 'card-text text-success fw-bold';
            price.textContent = `â‚¹${product.current_price}`;
            
            // View details link
            const detailsLink = document.createElement('a');
            detailsLink.href = `product-detail-integration.html?id=${product.id}`;
            detailsLink.className = 'btn btn-outline-success btn-sm mt-auto';
            detailsLink.textContent = 'View Details';
            
            // Assemble card
            cardBody.appendChild(title);
            cardBody.appendChild(price);
            cardBody.appendChild(detailsLink);
            
            cardDiv.appendChild(img);
            cardDiv.appendChild(cardBody);
            
            colDiv.appendChild(cardDiv);
            
            return colDiv;
        }

        // Set up event listeners
        function setupEventListeners() {
            // Quantity selector
            decreaseQuantityBtn.addEventListener('click', () => {
                const currentValue = parseInt(quantityInput.value);
                if (currentValue > 1) {
                    quantityInput.value = currentValue - 1;
                }
            });
            
            increaseQuantityBtn.addEventListener('click', () => {
                const currentValue = parseInt(quantityInput.value);
                quantityInput.value = currentValue + 1;
            });
            
            // Validate quantity input
            quantityInput.addEventListener('change', () => {
                let value = parseInt(quantityInput.value);
                if (isNaN(value) || value < 1) {
                    quantityInput.value = 1;
                }
            });
            
            // Add to cart button
            addToCartBtn.addEventListener('click', async () => {
                try {
                    loadingSpinner.style.display = 'block';
                    
                    // Get product details
                    const product = await getProduct(productId);
                    
                    // Get quantity
                    const quantity = parseInt(quantityInput.value);
                    
                    // Add to cart
                    addToCart(product, quantity);
                    
                    // Show success message
                    showAddedToCartMessage(product.name, quantity);
                    
                    loadingSpinner.style.display = 'none';
                } catch (error) {
                    console.error('Error adding to cart:', error);
                    loadingSpinner.style.display = 'none';
                    alert('Failed to add product to cart');
                }
            });
        }

        // Show error message
        function showError(message) {
            productLoading.style.display = 'none';
            productContainer.classList.add('d-none');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger text-center my-5';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i> ${message}`;
            
            const container = document.querySelector('.container');
            container.appendChild(errorDiv);
        }

        // Show added to cart message
        function showAddedToCartMessage(productName, quantity) {
            // Create toast element
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
            toastContainer.style.zIndex = '5';
            
            const toastElement = document.createElement('div');
            toastElement.className = 'toast';
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            
            const toastHeader = document.createElement('div');
            toastHeader.className = 'toast-header bg-success text-white';
            toastHeader.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Added to Cart</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            `;
            
            const toastBody = document.createElement('div');
            toastBody.className = 'toast-body';
            toastBody.innerHTML = `
                <p class="mb-1">${quantity} x ${productName} added to your cart.</p>
                <div class="mt-2 pt-2 border-top">
                    <a href="cart.html" class="btn btn-success btn-sm">View Cart</a>
                    <a href="checkout.html" class="btn btn-outline-success btn-sm ms-2">Checkout</a>
                </div>
            `;
            
            toastElement.appendChild(toastHeader);
            toastElement.appendChild(toastBody);
            toastContainer.appendChild(toastElement);
            
            // Add to document
            document.body.appendChild(toastContainer);
            
            // Initialize and show toast
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            
            // Remove from DOM after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastContainer);
            });
        }
    </script>
</body>
</html>